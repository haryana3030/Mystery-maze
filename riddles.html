<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harry Potter Riddle Quest</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Harry+P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: url('greathall.png') no-repeat center center fixed;
            background-size: cover
            font-family: 'MedievalSharp', cursive;
            color: #FFD700;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
            touch-action: manipulation;
        }
        #parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: url('greathall.png') no-repeat center center;
            background-size: cover;
            transform: translateZ(-1px) scale(1.2);
            transition: transform 0.3s ease-out;
        }
        .header {
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 2px solid #FFD700;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 0.5rem 1rem;
        }
        .sidebar {
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid #FFD700;
            transition: all 0.3s ease;
            overflow-y: auto;
            perspective: 1000px;
            width: 100%;
            max-height: 40vh;
            position: fixed;
            bottom: 0;
            border-top: 2px solid #FFD700;
            z-index: 20;
            transform: translateY(100%);
        }
        .sidebar.open {
            transform: translateY(0);
        }
        .sidebar-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 30;
            background: #FFD700;
            color: #1a1a1a;
            padding: 0.5rem;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255,215,0,0.8);
        }
        @media (min-width: 768px) {
            .sidebar {
                width: 20rem;
                max-height: none;
                position: static;
                border-top: none;
                border-left: 2px solid #FFD700;
                transform: none;
            }
            .sidebar-toggle {
                display: none;
            }
        }
        .main-content {
            flex-direction: column;
            min-height: calc(100vh - 4rem);
        }
        .riddle-card {
            perspective: 2000px;
            transform-style: preserve-3d;
            animation: float 6s ease-in-out infinite;
            margin-bottom: 2rem;
            width: 90%;
            max-width: 28rem;
            height: 24rem;
        }
        @media (min-width: 640px) {
            .riddle-card {
                margin-bottom: 1rem;
                max-width: 32rem;
                height: 28rem;
            }
        }
        .card-inner {
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 20px rgba(255,215,0,0.3);
            height: 100%;
        }
        .card-front, .card-back {
            backface-visibility: hidden;
            border-radius: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(139,0,0,0.9), rgba(0,0,0,0.9));
            border: 2px solid #FFD700;
            box-shadow: inset 0 0 10px #FFD700;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, rgba(0,100,0,0.9), rgba(0,0,0,0.9));
        }
        .progress-map {
            flex-wrap: wrap;
            gap: 0.25rem;
            padding: 0.5rem;
            max-width: 90%;
        }
        .progress-icon {
            transition: transform 0.5s ease, color 0.3s;
            animation: pulse 2s infinite;
            font-size: 0.75rem;
        }
        .progress-icon.completed {
            transform: scale(1.3) rotate(360deg);
            animation: none;
        }
        .leaderboard-item {
            transition: background 0.3s, transform 0.2s;
            transform-style: preserve-3d;
            transform: rotateX(5deg) rotateY(10deg);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            animation: leaderboard-float 4s ease-in-out infinite;
            font-size: 0.875rem;
            padding: 0.5rem;
        }
        .leaderboard-item:hover {
            background: rgba(255,215,0,0.3);
            transform: translateX(5px) rotateX(0deg) rotateY(0deg);
        }
        .parallax {
            transition: transform 0.2s ease-out;
        }
        .input-glow {
            transition: box-shadow 0.3s;
            font-size: 0.875rem;
            padding: 0.5rem;
            width: 100%;
            max-width: 20rem;
        }
        .input-glow:focus {
            box-shadow: 0 0 15px #FFD700;
            outline: none;
        }
        .btn-glow {
            transition: box-shadow 0.3s, transform 0.2s;
            padding: 0.5rem 1.5rem;
            font-size: 0.875rem;
        }
        .btn-glow:hover {
            box-shadow: 0 0 20px #FFD700;
            transform: scale(1.05);
        }
        #get-riddle-btn {
            perspective: 1000px;
            transform-style: preserve-3d;
            animation: button-float 4s ease-in-out infinite;
            background: linear-gradient(135deg, #FFD700, #DAA520);
            border: 3px solid #FFD700;
            box-shadow: 0 0 30px rgba(255,215,0,0.8), inset 0 0 15px rgba(255,255,255,0.4);
            text-shadow: 0 0 10px rgba(0,0,0,0.7);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            padding: 0.75rem 2rem;
            font-size: 1.25rem;
            border-radius: 1rem;
            color: #1a1a1a;
            font-family: 'Harry P', sans-serif;
            position: relative;
            overflow: hidden;
            z-index: 100;
        }
        #get-riddle-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 10%, transparent 10.1%);
            background-size: 15px 15px;
            opacity: 0;
            transition: opacity 0.5s ease;
            animation: sparkle 3s infinite;
        }
        #get-riddle-btn:hover::before {
            opacity: 0.7;
        }
        #get-riddle-btn:hover {
            transform: scale(1.1) rotateX(15deg) rotateY(15deg);
            box-shadow: 0 0 40px rgba(255,215,0,1), inset 0 0 20px rgba(255,255,255,0.6);
        }
        #get-riddle-btn:active {
            transform: scale(0.95) rotateX(10deg) rotateY(10deg);
            box-shadow: 0 0 20px rgba(255,215,0,0.6), inset 0 0 10px rgba(255,255,255,0.3);
        }
        @media (min-width: 640px) {
            #get-riddle-btn {
                padding: 1rem 2.5rem;
                font-size: 1.5rem;
            }
        }
        @keyframes float {
            0% { transform: translateY(0px) rotateX(0deg); }
            50% { transform: translateY(-5px) rotateX(3deg); }
            100% { transform: translateY(0px) rotateX(0deg); }
        }
        @keyframes leaderboard-float {
            0% { transform: rotateX(5deg) rotateY(10deg) translateY(0); }
            50% { transform: rotateX(8deg) rotateY(5deg) translateY(-3px); }
            100% { transform: rotateX(5deg) rotateY(10deg) translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes button-float {
            0% { transform: translateY(0px) rotateX(0deg) rotateY(0deg); }
            50% { transform: translateY(-10px) rotateX(15deg) rotateY(15deg); }
            100% { transform: translateY(0px) rotateX(0deg) rotateY(0deg); }
        }
        @keyframes sparkle {
            0% { transform: translate(0, 0); }
            50% { transform: translate(10%, 10%); }
            100% { transform: translate(0, 0); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen relative">
    <div id="parallax-bg"></div>

    <header class="header flex justify-between items-center w-full z-10">
        <h1 class="text-2xl font-['Harry_P'] text-yellow-400 sm:text-3xl md:text-4xl">Riddle Questâš¡ï¸</h1>
        <div class="flex items-center space-x-2 sm:space-x-4">
            <span id="score-display" class="text-base sm:text-xl">Points: 0</span>
            <button id="mute-btn" class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700"><i class="fas fa-volume-up"></i></button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden main-content">
        <section class="flex-1 flex flex-col items-center justify-start p-2 sm:p-4 parallax">
            <button id="get-riddle-btn" class="btn-glow">Get Riddle</button>
            <div id="progress-map" class="progress-map flex justify-center mb-4 sm:mb-6 hidden"></div>

            <div class="riddle-card relative hidden">
                <div class="card-inner w-full h-full flex flex-col justify-center items-center">
                    <div class="card-front flex flex-col justify-center items-center text-center">
                        <p id="riddle-text" class="text-base sm:text-lg md:text-xl mb-2 sm:mb-4 font-bold"></p>
                        <input id="answer-input" type="text" placeholder="ENTER ANSWER IN CAPS" class="p-2 rounded bg-gray-900 border border-yellow-400 text-white uppercase input-glow">
                        <button id="submit-answer" class="mt-2 sm:mt-4 px-4 sm:px-6 py-1 sm:py-2 bg-yellow-600 text-black rounded-lg font-bold btn-glow">Cast Spell</button>
                        <p id="attempts-text" class="mt-2 text-sm sm:text-base">Attempts left: 5</p>
                        <p id="timer-text" class="mt-1 text-sm sm:text-base">Time: 0s</p>
                    </div>
                    <div class="card-back flex flex-col justify-center items-center text-center">
                        <p id="back-text" class="text-base sm:text-lg md:text-xl mb-2 sm:mb-4 font-bold"></p>
                    </div>
                </div>
            </div>
        </section>

        <aside id="sidebar" class="sidebar p-2 sm:p-4 flex flex-col">
            <h2 class="text-lg sm:text-xl md:text-2xl mb-2 border-b border-yellow-400 pb-1">Leaderboard</h2>
            <ul id="leaderboard-list" class="space-y-2"></ul>
            <div id="team-stats" class="mt-4 sm:mt-6 hidden">
                <h3 class="text-base sm:text-lg md:text-xl mb-2">Your Wand Stats</h3>
                <ul id="stats-list" class="space-y-1 text-xs sm:text-sm"></ul>
            </div>
        </aside>
        <button id="sidebar-toggle" class="sidebar-toggle"><i class="fas fa-bars"></i></button>
    </main>

    <audio id="correct-sound" src="https://www.soundjay.com/buttons/button-3.mp3"></audio>
    <audio id="wrong-sound" src="https://www.soundjay.com/buttons/button-10.mp3"></audio>

<script>
// ------------------------- GOOGLE APPS SCRIPT URL -------------------------
// !!! IMPORTANT: Replace this with your actual deployed Apps Script URL !!!
const backendUrl = "https://script.google.com/macros/s/AKfycbzTBFH4zwaenDURIVNek6rKMTzTdDsk8LltYsnzdRk2aa996waX6WRuSH82sKGXMebqmw/exec";

let team = {
Â  Â  id: null,
Â  Â  name: "Gryffindor",
Â  Â  score: 0
};
let userProgress = {};
const praises = ["Bravo!", "Excellent!", "Lightning fast!", "Well done!", "Impressive!", "Superb!", "Outstanding!", "Magnificent!", "Brilliant!", "Fantastic!"];
let allRiddles = [];
let teamRiddles = [];
let currentRiddleIndex = 0;
let attemptsUsed = 0;
let maxAttempts = 5;
let attemptsLeft = maxAttempts;
let timer = 0;
let timerInterval = null;
let muted = false;
let mouseX = 0, mouseY = 0;
let targetX = 0, targetY = 0;

// ------------------------- ELEMENTS -------------------------
const riddleText = document.getElementById('riddle-text');
const answerInput = document.getElementById('answer-input');
const submitBtn = document.getElementById('submit-answer');
const attemptsText = document.getElementById('attempts-text');
const timerText = document.getElementById('timer-text');
const backText = document.getElementById('back-text');
const leaderboardList = document.getElementById('leaderboard-list');
const progressMap = document.getElementById('progress-map');
const cardInner = document.querySelector('.card-inner');
const muteBtn = document.getElementById('mute-btn');
const teamStats = document.getElementById('team-stats');
const statsList = document.getElementById('stats-list');
const correctSound = document.getElementById('correct-sound');
const wrongSound = document.getElementById('wrong-sound');
const scoreDisplay = document.getElementById('score-display');
const parallaxElements = document.querySelectorAll('.parallax');
const parallaxBg = document.getElementById('parallax-bg');
const getRiddleBtn = document.getElementById('get-riddle-btn');
const riddleCard = document.querySelector('.riddle-card');
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebar-toggle');

// ------------------------- UNIQUE USER IDENTIFIER & SEEDED SHUFFLE -------------------------
function getUserId() {
Â  Â  return localStorage.getItem('roll');
}

function hashString(str) {
Â  Â  let hash = 0;
Â  Â  for (let i = 0; i < str.length; i++) {
Â  Â  Â  Â  const char = str.charCodeAt(i);
Â  Â  Â  Â  hash = (hash << 5) - hash + char;
Â  Â  Â  Â  hash |= 0;
Â  Â  }
Â  Â  return hash;
}

function mulberry32(seed) {
Â  Â  return function() {
Â  Â  Â  Â  let t = seed += 0x6D2B79F5;
Â  Â  Â  Â  t = Math.imul(t ^ (t >>> 15), t | 1);
Â  Â  Â  Â  t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
Â  Â  Â  Â  return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
Â  Â  };
}

function shuffleArray(array, seed) {
Â  Â  const rand = mulberry32(hashString(seed));
Â  Â  for (let i = array.length - 1; i > 0; i--) {
Â  Â  Â  Â  const j = Math.floor(rand() * (i + 1));
Â  Â  Â  Â  [array[i], array[j]] = [array[j], array[i]];
Â  Â  }
Â  Â  return array;
}

// ------------------------- SIDEBAR TOGGLE -------------------------
sidebarToggle.addEventListener('click', () => {
Â  Â  sidebar.classList.toggle('open');
Â  Â  sidebarToggle.innerHTML = sidebar.classList.contains('open') ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
});

// ------------------------- INIT GAME FUNCTION -------------------------
async function initGame() {
Â  Â  const rollNumber = getUserId();
Â  Â  if (!rollNumber) {
Â  Â  Â  Â  alert("Please log in to start the quest.");
Â  Â  Â  Â  window.location.href = 'login.html';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  team.id = rollNumber;

Â  Â  getRiddleBtn.classList.add('hidden');
Â  Â  riddleCard.classList.remove('hidden');
Â  Â  progressMap.classList.remove('hidden');

Â  Â  try {
Â  Â  Â  Â  const riddlesRes = await fetch(`${backendUrl}?path=getQuestions`);
Â  Â  Â  Â  const riddlesData = await riddlesRes.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (riddlesData.success && riddlesData.questions && riddlesData.questions.length > 0) {
Â  Â  Â  Â  Â  Â  allRiddles = riddlesData.questions;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const localProgress = localStorage.getItem(`progress_${team.id}`);
Â  Â  Â  Â  Â  Â  if (localProgress) {
Â  Â  Â  Â  Â  Â  Â  Â  userProgress = JSON.parse(localProgress);
Â  Â  Â  Â  Â  Â  Â  Â  teamRiddles = userProgress.riddleOrder;
Â  Â  Â  Â  Â  Â  Â  Â  currentRiddleIndex = userProgress.currentRiddleIndex;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  teamRiddles = shuffleArray([...allRiddles], team.id);
Â  Â  Â  Â  Â  Â  Â  Â  userProgress = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  riddleOrder: teamRiddles,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solvedRiddles: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  partialRiddles: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRiddleIndex: 0
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  saveLocalProgress();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  progressMap.innerHTML = '';
Â  Â  Â  Â  Â  Â  teamRiddles.forEach((riddle, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const span = document.createElement('i');
Â  Â  Â  Â  Â  Â  Â  Â  span.classList.add('fas', 'fa-circle', 'progress-icon', 'opacity-70');
Â  Â  Â  Â  Â  Â  Â  Â  if (userProgress.solvedRiddles[riddle.qid]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  span.classList.remove('opacity-70');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  span.classList.add('fa-check-circle', 'completed');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  span.style.color = '#00FF00';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  progressMap.appendChild(span);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  updateScoreDisplay();
Â  Â  Â  Â  Â  Â  loadRiddle();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error("Failed to fetch riddles:", riddlesData.message);
Â  Â  Â  Â  Â  Â  riddleText.textContent = "Error loading riddles. Please try again later.";
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Network or fetch error:", error);
Â  Â  Â  Â  riddleText.textContent = "Error connecting to the magical network. Please check your connection.";
Â  Â  }
}

// ------------------------- GET RIDDLE BUTTON LOGIC -------------------------
getRiddleBtn.addEventListener('click', initGame);

// ------------------------- MUTE TOGGLE -------------------------
muteBtn.addEventListener('click', () => {
Â  Â  muted = !muted;
Â  Â  muteBtn.innerHTML = muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
});

// ------------------------- TIMER -------------------------
function startTimer() {
Â  Â  timer = 0;
Â  Â  timerText.textContent = "Time: 0s";
Â  Â  clearInterval(timerInterval);
Â  Â  timerInterval = setInterval(() => {
Â  Â  Â  Â  timer++;
Â  Â  Â  Â  timerText.textContent = `Time: ${timer}s`;
Â  Â  }, 1000);
}

// ------------------------- LOAD RIDDLE -------------------------
function loadRiddle() {
Â  Â  saveLocalProgress();

Â  Â  if (currentRiddleIndex >= teamRiddles.length) {
Â  Â  Â  Â  showFinalLeaderboard();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  const currentRiddle = teamRiddles[currentRiddleIndex];

Â  Â  if (userProgress.solvedRiddles[currentRiddle.qid]) {
Â  Â  Â  Â  currentRiddleIndex++;
Â  Â  Â  Â  loadRiddle();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (userProgress.partialRiddles && userProgress.partialRiddles[currentRiddle.qid]) {
Â  Â  Â  Â  attemptsUsed = userProgress.partialRiddles[currentRiddle.qid].attemptsUsed;
Â  Â  Â  Â  attemptsLeft = maxAttempts - attemptsUsed;
Â  Â  } else {
Â  Â  Â  Â  attemptsUsed = 0;
Â  Â  Â  Â  attemptsLeft = maxAttempts;
Â  Â  }

Â  Â  attemptsText.textContent = `Attempts left: ${attemptsLeft}`;
Â  Â  answerInput.value = '';
Â  Â  riddleText.textContent = currentRiddle.question;
Â  Â  backText.textContent = '';
Â  Â  cardInner.style.transform = 'rotateY(0deg)';
Â  Â  submitBtn.disabled = false;
Â  Â  startTimer();
}

// ------------------------- SCORE LOGIC -------------------------
function calculatePoints(attempt) {
Â  Â  if (attempt === 1) return 10;
Â  Â  if (attempt === 2) return 8;
Â  Â  if (attempt === 3) return 6;
Â  Â  if (attempt === 4) return 4;
Â  Â  if (attempt === 5) return 2;
Â  Â  return 0;
}

// ------------------------- UPDATE PROGRESS -------------------------
function updateProgress(correct) {
Â  Â  const progressIcons = progressMap.querySelectorAll('.progress-icon');
Â  Â  if (progressIcons[currentRiddleIndex]) {
Â  Â  Â  Â  progressIcons[currentRiddleIndex].classList.remove('fa-circle', 'opacity-70');
Â  Â  Â  Â  progressIcons[currentRiddleIndex].classList.add(correct ? 'fa-check-circle' : 'fa-times-circle', 'completed');
Â  Â  Â  Â  progressIcons[currentRiddleIndex].style.color = correct ? '#00FF00' : '#FF0000';
Â  Â  }
}

// ------------------------- SUBMIT ANSWER -------------------------
submitBtn.addEventListener('click', async () => {
Â  Â  const userAnswer = answerInput.value.trim().toUpperCase();
Â  Â  if (!userAnswer) return;

Â  Â  submitBtn.disabled = true;

Â  Â  attemptsUsed++;
Â  Â  let correct = false;

Â  Â  const currentRiddle = teamRiddles[currentRiddleIndex];
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${backendUrl}?path=checkAnswer&qid=${currentRiddle.qid}&answer=${userAnswer}`);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (data.isCorrect) {
Â  Â  Â  Â  Â  Â  correct = true;
Â  Â  Â  Â  Â  Â  clearInterval(timerInterval);
Â  Â  Â  Â  Â  Â  const points = calculatePoints(attemptsUsed);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (userProgress.partialRiddles) {
Â  Â  Â  Â  Â  Â  Â  Â  delete userProgress.partialRiddles[currentRiddle.qid];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  userProgress.solvedRiddles[currentRiddle.qid] = { attempts: attemptsUsed, score: points };
Â  Â  Â  Â  Â  Â  userProgress.currentRiddleIndex = currentRiddleIndex + 1;
Â  Â  Â  Â  Â  Â  saveLocalProgress();

            // â­ Key change is here: Update local score, THEN send to backend
Â  Â  Â  Â  Â  Â  updateScoreDisplay();
Â  Â  Â  Â  Â  Â  await updateScoreOnBackend(team.score);

Â  Â  Â  Â  Â  Â  const randomPraise = praises[Math.floor(Math.random() * praises.length)];
Â  Â  Â  Â  Â  Â  backText.textContent = `${randomPraise} +${points} points`;
Â  Â  Â  Â  Â  Â  if (!muted) correctSound.play();
Â  Â  Â  Â  Â  Â  cardInner.style.transform = 'rotateY(180deg)';
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(correct);
Â  Â  Â  Â  Â  Â  Â  Â  cardInner.style.transform = 'rotateY(0deg)';
Â  Â  Â  Â  Â  Â  Â  Â  currentRiddleIndex++;
Â  Â  Â  Â  Â  Â  Â  Â  loadRiddle();
Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (!muted) wrongSound.play();
Â  Â  Â  Â  Â  Â  attemptsLeft--;
Â  Â  Â  Â  Â  Â  attemptsText.textContent = `Attempts left: ${attemptsLeft}`;
Â  Â  Â  Â  Â  Â  if (attemptsLeft > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!userProgress.partialRiddles) userProgress.partialRiddles = {};
Â  Â  Â  Â  Â  Â  Â  Â  userProgress.partialRiddles[currentRiddle.qid] = { attemptsUsed: attemptsUsed };
Â  Â  Â  Â  Â  Â  Â  Â  saveLocalProgress();

Â  Â  Â  Â  Â  Â  Â  Â  backText.textContent = `Incorrect! Try again.`;
Â  Â  Â  Â  Â  Â  Â  Â  cardInner.style.transform = 'rotateY(180deg)';
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardInner.style.transform = 'rotateY(0deg)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backText.textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timerInterval);
Â  Â  Â  Â  Â  Â  Â  Â  backText.textContent = `Out of attempts!`;
Â  Â  Â  Â  Â  Â  Â  Â  cardInner.style.transform = 'rotateY(180deg)';
Â  Â  Â  Â  Â  Â  Â  Â  updateProgress(correct);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (userProgress.partialRiddles) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete userProgress.partialRiddles[currentRiddle.qid];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  userProgress.currentRiddleIndex = currentRiddleIndex + 1;
Â  Â  Â  Â  Â  Â  Â  Â  saveLocalProgress();

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardInner.style.transform = 'rotateY(0deg)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRiddleIndex++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadRiddle();
Â  Â  Â  Â  Â  Â  Â  Â  }, 2500);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error checking answer:', error);
Â  Â  Â  Â  backText.textContent = "Error checking answer. Please try again.";
Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  }
});

// â­ NEW FUNCTION TO UPDATE SCORE ON BACKEND
async function updateScoreOnBackend(score) {
Â  Â  try {
Â  Â  Â  Â  await fetch(`${backendUrl}?path=saveFinalScore`, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ rollNumber: team.id, score }),
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log("Score successfully sent to backend.");
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Failed to send score to backend:", error);
Â  Â  }
}

// ------------------------- SAVE LOCAL PROGRESS -------------------------
function saveLocalProgress() {
Â  Â  localStorage.setItem(`progress_${team.id}`, JSON.stringify(userProgress));
}

// ------------------------- UPDATE SCORE DISPLAY (LOCAL) -------------------------
function updateScoreDisplay() {
Â  Â  let totalScore = 0;
Â  Â  for (const qid in userProgress.solvedRiddles) {
Â  Â  Â  Â  totalScore += userProgress.solvedRiddles[qid].score;
Â  Â  }
Â  Â  team.score = totalScore;
Â  Â  scoreDisplay.textContent = `Points: ${team.score}`;
}

// ------------------------- LEADERBOARD (Fetch from backend) -------------------------
async function updateLeaderboard() {
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${backendUrl}?path=leaderboard`);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!Array.isArray(data)) {
Â  Â  Â  Â  Â  Â  console.error("Leaderboard data is not an array:", data);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  data.sort((a, b) => b.score - a.score);
Â  Â  Â  Â  leaderboardList.innerHTML = data.map((t, index) => `
Â  Â  Â  Â  Â  Â  <li class="leaderboard-item flex justify-between p-2 rounded bg-gray-900 border border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <span><i class="fas fa-trophy mr-1 ${index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : 'text-orange-600'}"></i>${t.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span>${t.score} pts</span>
Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  `).join('');
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error fetching leaderboard:', error);
Â  Â  Â  Â  leaderboardList.innerHTML = `
Â  Â  Â  Â  Â  Â  <li class="leaderboard-item flex justify-between p-2 rounded bg-gray-900 border border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <span><i class="fas fa-trophy mr-1 text-yellow-400"></i>${team.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span>${team.score} pts</span>
Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  `;
Â  Â  }
}

// Poll leaderboard every 5s for real-time
setInterval(updateLeaderboard, 5000);

// ------------------------- FINAL LEADERBOARD -------------------------
function showFinalLeaderboard() {
Â  Â  clearInterval(timerInterval);
Â  Â  riddleText.textContent = "ğŸ† Quest Completed! ğŸ†";
Â  Â  answerInput.style.display = 'none';
Â  Â  submitBtn.style.display = 'none';
Â  Â  attemptsText.style.display = 'none';
Â  Â  timerText.style.display = 'none';
Â  Â  backText.textContent = `Final Points: ${team.score}`;
Â  Â  cardInner.style.transform = 'rotateY(180deg)';
Â  Â Â 
Â  Â  // Save the final score one last time
Â  Â  updateScoreOnBackend(team.score);

Â  Â  teamStats.classList.remove('hidden');
Â  Â  statsList.innerHTML = Object.keys(userProgress.solvedRiddles).map(qid => {
Â  Â  Â  Â  const riddle = userProgress.solvedRiddles[qid];
Â  Â  Â  Â  return `<li class="p-1 bg-gray-900 rounded border border-gray-700">Riddle ${qid}: ${riddle.score} pts | ${riddle.attempts} attempts</li>`;
Â  Â  }).join('');

Â  Â  setTimeout(() => {
Â  Â  Â  Â  window.location.href = 'thankyou.html';
Â  Â  }, 10000);
}

// ------------------------- SMOOTH PARALLAX EFFECT -------------------------
function lerp(start, end, factor) {
Â  Â  return start + (end - start) * factor;
}

document.addEventListener('mousemove', (e) => {
Â  Â  const { clientX, clientY } = e;
Â  Â  const { innerWidth: w, innerHeight: h } = window;
Â  Â  targetX = (clientX / w * 2 - 1) * 5;
Â  Â  targetY = (clientY / h * 2 - 1) * 5;
});

document.addEventListener('touchmove', (e) => {
Â  Â  const touch = e.touches[0];
Â  Â  const { innerWidth: w, innerHeight: h } = window;
Â  Â  targetX = (touch.clientX / w * 2 - 1) * 5;
Â  Â  targetY = (touch.clientY / h * 2 - 1) * 5;
});

function updateParallax() {
Â  Â  mouseX = lerp(mouseX, targetX, 0.1);
Â  Â  mouseY = lerp(mouseY, targetY, 0.1);

Â  Â  parallaxElements.forEach(el => {
Â  Â  Â  Â  el.style.transform = `translate(${mouseX}px, ${mouseY}px)`;
Â  Â  });

Â  Â  parallaxBg.style.transform = `translate(${mouseX/2}px, ${mouseY/2}px) scale(1.2)`;
Â  Â  requestAnimationFrame(updateParallax);
}

// Start parallax animation
requestAnimationFrame(updateParallax);

// ------------------------- INIT -------------------------
window.onload = initGame;
</script>
</body>
</html>
